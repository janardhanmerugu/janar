(function () {
  // Default Pace configuration
  var defaultOptions = {
    catchupTime: 100,
    initialRate: 0.03,
    minTime: 250,
    ghostTime: 100,
    maxProgressPerFrame: 20,
    easeFactor: 1.25,
    startOnPageLoad: true,
    restartOnPushState: true,
    restartOnRequestAfter: 500,
    target: "body",
    elements: {
      checkInterval: 100,
      selectors: ["body"]
    },
    eventLag: {
      minSamples: 10,
      sampleCount: 3,
      lagThreshold: 3
    },
    ajax: {
      trackMethods: ["GET"],
      trackWebSockets: true,
      ignoreURLs: []
    }
  };

  // Timestamp helper
  function now() {
    if (window.performance && typeof window.performance.now === "function") {
      return window.performance.now();
    }
    return +new Date();
  }

  // Polyfill for requestAnimationFrame
  var requestFrame = window.requestAnimationFrame ||
    window.mozRequestAnimationFrame ||
    window.webkitRequestAnimationFrame ||
    function (fn) { return setTimeout(fn, 50); };

  var cancelFrame = window.cancelAnimationFrame ||
    window.mozCancelAnimationFrame ||
    function (id) { clearTimeout(id); };

  // Pace main object
  var Pace = window.Pace || {};

  Pace.options = Object.assign({}, defaultOptions, window.paceOptions);

  // Create Pace bar UI
  Pace.Bar = function () {
    this.progress = 0;
    this.el = null;
  };

  Pace.Bar.prototype.getElement = function () {
    if (!this.el) {
      var target = document.querySelector(Pace.options.target);
      if (!target) throw new Error("Pace target element not found");

      this.el = document.createElement("div");
      this.el.className = "pace pace-active";
      this.el.innerHTML = `
        <div class="pace-progress">
          <div class="pace-progress-inner"></div>
        </div>
        <div class="pace-activity"></div>
      `;

      target.insertBefore(this.el, target.firstChild);
      document.body.classList.add("pace-running");
    }
    return this.el;
  };

  Pace.Bar.prototype.update = function (progress) {
    this.progress = progress;
    this.render();
  };

  Pace.Bar.prototype.render = function () {
    var bar = this.getElement();
    var progress = Math.min(this.progress, 100);
    var transform = `translate3d(${progress}%, 0, 0)`;

    bar.querySelector(".pace-progress").style.transform = transform;
    bar.querySelector(".pace-progress-inner").setAttribute("data-progress", Math.floor(progress));
  };

  Pace.Bar.prototype.finish = function () {
    var bar = this.getElement();
    bar.classList.remove("pace-active");
    bar.classList.add("pace-inactive");
    document.body.classList.remove("pace-running");
    document.body.classList.add("pace-done");
  };

  // Pace logic controller
  Pace.Controller = function () {
    this.sources = [];
    this.bar = new Pace.Bar();
    this.running = false;
  };

  Pace.Controller.prototype.start = function () {
    if (this.running) return;
    this.running = true;
    this.bar.getElement();
    this.tick();
  };

  Pace.Controller.prototype.stop = function () {
    this.running = false;
    this.bar.finish();
  };

  Pace.Controller.prototype.tick = function () {
    if (!this.running) return;

    this.bar.update(this.bar.progress + 1);

    if (this.bar.progress < 100) {
      requestFrame(this.tick.bind(this));
    } else {
      this.stop();
    }
  };

  // Initialize Pace automatically if enabled
  Pace.start = function () {
    if (!Pace.controller) {
      Pace.controller = new Pace.Controller();
    }
    Pace.controller.start();
  };

  // Auto-start when page loads
  if (Pace.options.startOnPageLoad) {
    document.addEventListener("DOMContentLoaded", function () {
      Pace.start();
    });
  }

  window.Pace = Pace;
})();
